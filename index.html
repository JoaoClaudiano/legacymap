<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Legacy Map Pro</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/reactflow@11.10.1/dist/react-flow.standalone.am.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/reactflow@11.10.1/dist/style.css">
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <header class="main-header">
        <div class="logo">üó∫Ô∏è LEGACY<span style="color: #3b82f6;">MAP</span></div>
        <div class="version-tag">v2.3 (Stable)</div>
    </header>

    <div id="app"></div>

    <footer class="main-footer">
        Conectado √† API do GitHub ‚Ä¢ 2026
    </footer>

    <script type="text/babel">
        // Pegamos as ferramentas diretamente do escopo global (window)
        const { useState, useCallback, useEffect } = React;
        const { createRoot } = ReactDOM;
        
        // ReactFlow injeta tudo num objeto global chamado ReactFlow
        const ReactFlowComponent = window.ReactFlow.default || window.ReactFlow;
        const { Background, Controls } = window.ReactFlow;

        function App() {
            const [url, setUrl] = useState('');
            const [nodes, setNodes] = useState([]);
            const [edges, setEdges] = useState([]);
            const [status, setStatus] = useState('Pronto');
            const [repoBase, setRepoBase] = useState('');

            const getFileColor = (path) => {
                if (path.endsWith('.ts')) return '#1e40af';
                if (path.endsWith('.tsx')) return '#1d4ed8';
                if (path.endsWith('.jsx')) return '#06b6d4';
                return '#3b82f6';
            };

            const onNodeClick = useCallback((event, node) => {
                if (repoBase) window.open(`${repoBase}/blob/main/${node.id}`, '_blank');
            }, [repoBase]);

            const analyzeGithub = async () => {
                setStatus('üîç Conectando...');
                try {
                    const match = url.match(/github\.com\/([^/]+)\/([^/]+)/);
                    if (!match) return alert("URL inv√°lida.");
                    const [_, owner, repo] = match;
                    setRepoBase(`https://github.com/${owner}/${repo}`);

                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/main?recursive=1`).then(r => r.json());
                    if (!res.tree) throw new Error();

                    const files = res.tree
                        .filter(f => f.path.match(/\.(js|ts|jsx|tsx|css)$/) && !f.path.includes('node_modules'))
                        .slice(0, 40);
                    
                    const newNodes = files.map((f, i) => ({
                        id: f.path,
                        data: { label: f.path.split('/').pop() },
                        position: { x: (i % 6) * 180, y: Math.floor(i / 6) * 120 },
                        style: { 
                            background: getFileColor(f.path), color: '#fff', 
                            borderRadius: '6px', padding: '10px', width: 140, 
                            fontSize: '11px', textAlign: 'center', cursor: 'pointer',
                            border: 'none', boxShadow: '0 4px 6px rgba(0,0,0,0.3)'
                        }
                    }));

                    setNodes(newNodes);
                    setStatus(`‚úÖ Sucesso!`);
                } catch (err) {
                    setStatus('‚ùå Erro de conex√£o.');
                }
            };

            return (
                <div style={{ width: '100vw', height: 'calc(100vh - 95px)' }}>
                    <div id="ui-layer">
                        <div className="input-group">
                            <input 
                                placeholder="https://github.com/usuario/projeto" 
                                value={url} 
                                onChange={e => setUrl(e.target.value)} 
                            />
                            <button onClick={analyzeGithub}>GERAR MAPA</button>
                        </div>
                        <div className="status-box">Status: {status}</div>
                    </div>

                    <ReactFlowComponent 
                        nodes={nodes} 
                        edges={edges} 
                        onNodeClick={onNodeClick} 
                        fitView
                    >
                        <Background color="#1e293b" gap={25} />
                        <Controls />
                    </ReactFlowComponent>
                </div>
            );
        }

        // Renderiza√ß√£o padr√£o React 18
        const container = document.getElementById('app');
        const root = createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
