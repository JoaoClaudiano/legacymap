<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Legacy Map Pro</title>
    <link rel="stylesheet" href="style.css">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/reactflow@11.7.4/dist/react-flow.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/reactflow@11.7.4/dist/style.css">
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <header class="main-header">
        <div class="logo">üó∫Ô∏è LEGACY<span style="color: #3b82f6;">MAP</span></div>
        <div class="version-tag">v1.3.0 (UMD)</div>
    </header>

    <div id="app"></div>

    <footer class="main-footer">
        Dica: Abra o console (F12) se o mapa n√£o carregar.
    </footer>

    <script type="text/babel" data-presets="env,react">
        const { useState, useEffect, useCallback } = React;

        function App() {
            const [ready, setReady] = useState(false);
            const [debugMsg, setDebugMsg] = useState('Iniciando diagn√≥sticos...');
            const [url, setUrl] = useState('');
            const [nodes, setNodes] = useState([]);
            const [edges, setEdges] = useState([]);
            const [status, setStatus] = useState('Pronto');
            const [repoBase, setRepoBase] = useState('');

            // DIAGN√ìSTICO DE CARREGAMENTO
            useEffect(() => {
                let attempts = 0;
                const check = setInterval(() => {
                    attempts++;
                    console.log(`[Tentativa ${attempts}] Procurando ReactFlow no window...`, window.ReactFlow);
                    
                    // O React Flow UMD geralmente injeta o objeto 'ReactFlow' no window
                    // √Äs vezes ele injeta como window.ReactFlow.default
                    const rf = window.ReactFlow;
                    
                    if (rf) {
                        console.log("‚úÖ ReactFlow Encontrado!", rf);
                        setReady(true);
                        clearInterval(check);
                    } else {
                        setDebugMsg(`Tentativa ${attempts}: Biblioteca ainda n√£o carregou...`);
                    }

                    if (attempts > 50) { // Desiste ap√≥s 25 segundos
                        setDebugMsg("ERRO CR√çTICO: ReactFlow falhou ao carregar via CDN. Verifique sua conex√£o.");
                        clearInterval(check);
                    }
                }, 500);
                return () => clearInterval(check);
            }, []);

            // Se n√£o estiver pronto, mostra o que est√° acontecendo
            if (!ready) {
                return (
                    <div className="loading-screen" style={{flexDirection: 'column', gap: '20px'}}>
                        <div>CARREGANDO MOTOR GR√ÅFICO...</div>
                        <div style={{fontSize: '12px', color: '#64748b'}}>{debugMsg}</div>
                    </div>
                );
            }

            // Mapeamento seguro das propriedades
            // Na vers√£o UMD, geralmente ReactFlow √© o objeto principal
            const RF = window.ReactFlow; 
            // Se RF for uma fun√ß√£o/componente, usamos ele direto. Se for objeto com .default, usamos .default
            const ReactFlowComponent = RF.default || RF; 
            const { Background, Controls } = RF;

            const onNodeClick = useCallback((event, node) => {
                if (repoBase && node.id) {
                    window.open(`${repoBase}/blob/main/${node.id}`, '_blank');
                }
            }, [repoBase]);

            const analyzeGithub = async () => {
                setStatus('üîç Acessando GitHub...');
                try {
                    const match = url.match(/github\.com\/([^/]+)\/([^/]+)/);
                    if (!match) return alert("URL inv√°lida.");
                    const [_, owner, repo] = match;
                    
                    setRepoBase(`https://github.com/${owner}/${repo}`);

                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/main?recursive=1`).then(r => r.json());
                    if (!res.tree) throw new Error("Reposit√≥rio n√£o encontrado ou privado");

                    const files = res.tree
                        .filter(f => (f.path.match(/\.(js|ts|jsx|tsx|css)$/)) && !f.path.includes('node_modules'))
                        .slice(0, 30);
                    
                    const newNodes = files.map((f, i) => ({
                        id: f.path,
                        data: { label: f.path.split('/').pop() },
                        position: { x: (i % 5) * 200, y: Math.floor(i / 5) * 150 },
                        style: { 
                            background: f.path.endsWith('ts') ? '#1e40af' : '#3b82f6', 
                            color: '#fff', 
                            borderRadius: '8px', padding: '10px', width: 140, textAlign: 'center', cursor: 'pointer' 
                        }
                    }));

                    setNodes(newNodes);
                    setStatus(`‚úÖ ${newNodes.length} arquivos.`);
                } catch (err) {
                    console.error(err);
                    setStatus('‚ùå Erro: Repo privado ou limite de API.');
                }
            };

            return (
                <div style={{ width: '100vw', height: 'calc(100vh - 95px)' }}>
                    <div id="ui-layer">
                        <div className="input-group">
                            <input 
                                placeholder="Link do Reposit√≥rio" 
                                value={url} 
                                onChange={e => setUrl(e.target.value)} 
                            />
                            <button onClick={analyzeGithub}>MAPEAR</button>
                        </div>
                        <div className="status-box">{status}</div>
                    </div>

                    <ReactFlowComponent nodes={nodes} edges={edges} onNodeClick={onNodeClick} fitView>
                        <Background color="#1e293b" gap={25} />
                        <Controls />
                    </ReactFlowComponent>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<App />);
    </script>
</body>
</html>
