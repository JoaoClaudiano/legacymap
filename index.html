<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legacy Map Pro</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Carregar React 18 de CDN confi√°vel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/reactflow@11.10.1/dist/umd/react-flow.production.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/reactflow@11.10.1/dist/style.css">
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <header class="main-header">
        <div class="logo">üó∫Ô∏è LEGACY<span style="color: #3b82f6;">MAP</span></div>
        <div class="version-tag">v2.3 (Stable)</div>
    </header>

    <div id="app"></div>

    <footer class="main-footer">
        Conectado √† API do GitHub ‚Ä¢ 2026
    </footer>

    <script type="text/babel">
        const { useState, useCallback, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;
        
        // Obter ReactFlow do objeto global
        const ReactFlowComponent = window.ReactFlow?.default || window.ReactFlow?.ReactFlow;
        const { Background, Controls, MiniMap } = window.ReactFlow || {};

        function App() {
            const [url, setUrl] = useState('');
            const [nodes, setNodes] = useState([]);
            const [edges, setEdges] = useState([]);
            const [status, setStatus] = useState('Pronto');
            const [repoBase, setRepoBase] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const reactFlowWrapper = useRef(null);

            const getFileColor = (path) => {
                const colorMap = {
                    '.ts': '#1e40af',
                    '.tsx': '#1d4ed8',
                    '.jsx': '#06b6d4',
                    '.js': '#3b82f6',
                    '.css': '#8b5cf6',
                    '.scss': '#7c3aed',
                    '.json': '#f59e0b',
                    '.md': '#10b981',
                    '.html': '#ef4444',
                    '.py': '#3b82f6',
                    '.java': '#dc2626',
                    '.cpp': '#059669',
                    '.cs': '#4f46e5'
                };
                
                for (const [ext, color] of Object.entries(colorMap)) {
                    if (path.endsWith(ext)) return color;
                }
                return '#6b7280';
            };

            const getFileIcon = (path) => {
                if (path.endsWith('.ts') || path.endsWith('.tsx')) return 'TS';
                if (path.endsWith('.js') || path.endsWith('.jsx')) return 'JS';
                if (path.endsWith('.css')) return 'CSS';
                if (path.endsWith('.html')) return 'HTML';
                if (path.endsWith('.json')) return 'JSON';
                if (path.endsWith('.md')) return 'MD';
                return 'FILE';
            };

            const onNodeClick = useCallback((event, node) => {
                if (repoBase) {
                    window.open(`${repoBase}/blob/main/${node.id}`, '_blank');
                }
            }, [repoBase]);

            const analyzeGithub = async () => {
                if (!url) {
                    setError('Por favor, insira uma URL do GitHub');
                    return;
                }

                const match = url.match(/github\.com\/([^/]+)\/([^/]+)/);
                if (!match) {
                    setError('URL do GitHub inv√°lida. Formato esperado: https://github.com/usuario/repositorio');
                    return;
                }

                setLoading(true);
                setStatus('üîç Conectando ao GitHub...');
                setError(null);

                try {
                    const [_, owner, repo] = match;
                    const apiUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/main?recursive=1`;
                    
                    const res = await fetch(apiUrl, {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (!res.ok) {
                        if (res.status === 404) {
                            throw new Error('Reposit√≥rio n√£o encontrado. Verifique se o nome est√° correto.');
                        } else if (res.status === 403) {
                            throw new Error('Limite de requisi√ß√µes excedido. Tente novamente mais tarde.');
                        }
                        throw new Error(`Erro ${res.status}: ${res.statusText}`);
                    }

                    const data = await res.json();
                    
                    if (!data.tree) {
                        throw new Error('Estrutura do reposit√≥rio n√£o encontrada');
                    }

                    const files = data.tree
                        .filter(f => f.type === 'blob' && f.path.match(/\.(js|ts|jsx|tsx|css|scss|json|md|html|py|java|cpp|cs)$/))
                        .filter(f => !f.path.includes('node_modules') && !f.path.includes('dist') && !f.path.includes('build'))
                        .slice(0, 100); // Aumentado para 100 arquivos

                    if (files.length === 0) {
                        setError('Nenhum arquivo de c√≥digo encontrado no reposit√≥rio');
                        setNodes([]);
                        setStatus('‚ö†Ô∏è Nenhum arquivo encontrado');
                        return;
                    }

                    setRepoBase(`https://github.com/${owner}/${repo}`);

                    // Criar layout em grid mais organizado
                    const columns = Math.min(Math.ceil(Math.sqrt(files.length)), 8);
                    const nodeWidth = 160;
                    const nodeHeight = 100;
                    const horizontalSpacing = 200;
                    const verticalSpacing = 140;

                    const newNodes = files.map((f, i) => {
                        const column = i % columns;
                        const row = Math.floor(i / columns);
                        
                        return {
                            id: f.path,
                            data: { 
                                label: f.path.split('/').pop(),
                                fullPath: f.path,
                                icon: getFileIcon(f.path),
                                lines: Math.min(Math.floor(Math.random() * 1000) + 50, 2000) // Exemplo de m√©trica
                            },
                            position: { 
                                x: column * horizontalSpacing + 50, 
                                y: row * verticalSpacing + 50 
                            },
                            style: { 
                                background: getFileColor(f.path), 
                                color: '#fff', 
                                borderRadius: '8px', 
                                padding: '12px', 
                                width: nodeWidth, 
                                fontSize: '12px', 
                                textAlign: 'center',
                                cursor: 'pointer',
                                border: '2px solid rgba(255,255,255,0.1)',
                                boxShadow: '0 6px 12px rgba(0,0,0,0.3)',
                                transition: 'all 0.2s ease'
                            },
                            className: 'file-node'
                        };
                    });

                    // Criar conex√µes baseadas na estrutura de pastas
                    const newEdges = [];
                    const pathMap = {};
                    
                    files.forEach(f => {
                        const parts = f.path.split('/');
                        if (parts.length > 1) {
                            const parent = parts.slice(0, -1).join('/');
                            if (pathMap[parent]) {
                                newEdges.push({
                                    id: `e-${parent}-${f.path}`,
                                    source: parent,
                                    target: f.path,
                                    type: 'smoothstep',
                                    animated: false,
                                    style: { stroke: '#475569', strokeWidth: 1.5 }
                                });
                            }
                        }
                        pathMap[f.path] = true;
                    });

                    setNodes(newNodes);
                    setEdges(newEdges);
                    setStatus(`‚úÖ ${files.length} arquivos mapeados com sucesso!`);
                    
                } catch (err) {
                    console.error('Erro:', err);
                    setError(err.message);
                    setStatus('‚ùå Erro na conex√£o');
                    setNodes([]);
                    setEdges([]);
                } finally {
                    setLoading(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !loading) {
                    analyzeGithub();
                }
            };

            // Efeito de hover nos n√≥s
            useEffect(() => {
                const handleMouseEnter = (e) => {
                    if (e.target.closest('.file-node')) {
                        e.target.style.transform = 'translateY(-4px)';
                        e.target.style.boxShadow = '0 10px 20px rgba(0,0,0,0.4)';
                    }
                };
                
                const handleMouseLeave = (e) => {
                    if (e.target.closest('.file-node')) {
                        e.target.style.transform = 'translateY(0)';
                        e.target.style.boxShadow = '0 6px 12px rgba(0,0,0,0.3)';
                    }
                };

                document.addEventListener('mouseenter', handleMouseEnter, true);
                document.addEventListener('mouseleave', handleMouseLeave, true);

                return () => {
                    document.removeEventListener('mouseenter', handleMouseEnter, true);
                    document.removeEventListener('mouseleave', handleMouseLeave, true);
                };
            }, []);

            return (
                <div style={{ width: '100vw', height: 'calc(100vh - 95px)' }} ref={reactFlowWrapper}>
                    <div id="ui-layer" style={{
                        position: 'absolute',
                        top: '20px',
                        left: '20px',
                        zIndex: 10,
                        background: 'rgba(15, 23, 42, 0.9)',
                        padding: '20px',
                        borderRadius: '10px',
                        backdropFilter: 'blur(10px)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        minWidth: '350px'
                    }}>
                        <div style={{ marginBottom: '15px' }}>
                            <h3 style={{ margin: '0 0 10px 0', color: '#f8fafc' }}>GitHub Repository Mapper</h3>
                            <p style={{ fontSize: '12px', color: '#94a3b8', margin: '0' }}>
                                Insira a URL de um reposit√≥rio GitHub para visualizar sua estrutura
                            </p>
                        </div>
                        
                        <div className="input-group" style={{ display: 'flex', gap: '10px' }}>
                            <input 
                                placeholder="https://github.com/usuario/projeto" 
                                value={url} 
                                onChange={e => setUrl(e.target.value)}
                                onKeyPress={handleKeyPress}
                                disabled={loading}
                                style={{
                                    flex: 1,
                                    padding: '12px',
                                    borderRadius: '6px',
                                    border: '1px solid #475569',
                                    background: '#0f172a',
                                    color: '#f8fafc',
                                    fontSize: '14px'
                                }}
                            />
                            <button 
                                onClick={analyzeGithub}
                                disabled={loading}
                                style={{
                                    padding: '12px 24px',
                                    background: loading ? '#475569' : '#3b82f6',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: loading ? 'not-allowed' : 'pointer',
                                    fontWeight: 'bold',
                                    transition: 'background 0.2s'
                                }}
                            >
                                {loading ? 'PROCESSANDO...' : 'GERAR MAPA'}
                            </button>
                        </div>
                        
                        <div className="status-box" style={{
                            marginTop: '15px',
                            padding: '12px',
                            background: error ? '#fef2f2' : '#f0f9ff',
                            border: `1px solid ${error ? '#fecaca' : '#bae6fd'}`,
                            borderRadius: '6px',
                            fontSize: '14px',
                            color: error ? '#991b1b' : '#0369a1'
                        }}>
                            <strong>Status:</strong> {status}
                            {error && (
                                <div style={{ marginTop: '8px', fontSize: '13px' }}>
                                    {error}
                                </div>
                            )}
                        </div>
                        
                        {nodes.length > 0 && (
                            <div style={{
                                marginTop: '15px',
                                padding: '10px',
                                background: 'rgba(30, 41, 59, 0.8)',
                                borderRadius: '6px',
                                fontSize: '12px',
                                color: '#cbd5e1'
                            }}>
                                <strong>Dica:</strong> Clique em qualquer arquivo para abrir no GitHub
                                <div style={{ marginTop: '5px' }}>
                                    {nodes.length} arquivos ‚Ä¢ {edges.length} conex√µes
                                </div>
                            </div>
                        )}
                    </div>

                    {ReactFlowComponent ? (
                        <ReactFlowComponent 
                            nodes={nodes} 
                            edges={edges} 
                            onNodeClick={onNodeClick}
                            fitView
                            fitViewOptions={{ padding: 0.2 }}
                            nodesDraggable={true}
                            nodesConnectable={false}
                            zoomOnScroll={true}
                            panOnScroll={true}
                            style={{ background: '#0f172a' }}
                        >
                            <Background color="#1e293b" gap={30} size={1} />
                            <Controls 
                                style={{
                                    background: 'rgba(15, 23, 42, 0.9)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '6px'
                                }}
                            />
                            {MiniMap && (
                                <MiniMap 
                                    style={{
                                        background: 'rgba(15, 23, 42, 0.9)',
                                        border: '1px solid rgba(255,255,255,0.1)'
                                    }}
                                    nodeColor={(node) => getFileColor(node.id)}
                                />
                            )}
                        </ReactFlowComponent>
                    ) : (
                        <div style={{
                            display: 'flex',
                            justifyContent: 'center',
                            alignItems: 'center',
                            height: '100%',
                            color: '#94a3b8'
                        }}>
                            Erro ao carregar ReactFlow. Verifique a conex√£o com a internet.
                        </div>
                    )}
                </div>
            );
        }

        // Renderiza√ß√£o com tratamento de erro
        const container = document.getElementById('app');
        if (container) {
            try {
                const root = createRoot(container);
                root.render(<App />);
            } catch (error) {
                console.error('Erro ao renderizar aplica√ß√£o:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc2626;">
                        <h3>Erro ao carregar a aplica√ß√£o</h3>
                        <p>${error.message}</p>
                        <p>Recarregue a p√°gina ou verifique o console para mais detalhes.</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
